@model ICollection<OrderHistory>
@inject ApplicationDbContext _context
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> _userManager
@inject ApplicationDbContext _db
@inject IDDLHelper _ddlhelper
@{
    ViewData["Title"] = "UserBill";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var from = this.Context.Request.Query["from"];
    var to = this.Context.Request.Query["to"];
    var UserId = this.Context.Request.Query["UserId"];

    var user = await _userManager.GetUserAsync(User);
    //var BillOfUser = _db.OrderHistory.Where(x => x.UserId == user.Id);

    DateTime ToDate = DateTime.Now.AddDays(20);
    DateTime FromDate = DateTime.Now.AddDays(20);
    Boolean DateCheck = false;
    //IQueryable<OrderHistory> theInfo = Enumerable.Empty<OrderHistory>().AsQueryable();
    var theInfo = _db.OrderHistory.Where(x => x.UserId == user.Id && x.OrderDate >= FromDate && x.OrderDate <= ToDate).ToList();

    //List<OrderHistory> theInfo = new List<OrderHistory>();



    if (ViewBag.To != null && ViewBag.From != null)
    {
        ToDate = ViewBag.To;
        FromDate = ViewBag.From;
        //theInfo = _db.OrderHistory.Where(x => x.UserId == user.Id && x.OrderDate >= FromDate && x.OrderDate <= ToDate).ToList();

        DateCheck = true;

    }



}


<div class="container-fluid">

    <div class="row">
        <div class="col-sm-3">
            <h2>User Bill</h2>
        </div>


    </div>
    <hr />




    <div class="row">

        <form asp-action="DateFetch" method="post" class="d-lg-inline-flex">

            <div class="form-group">
                <label class="control-label">From:</label>
                <input type="date" name="from" id="from" class="col-sm-5" />
                <label class="control-label">To:</label>
                <input type="date" name="to" id="to" class="col-sm-5" />
                <button class="btn btn-sm btn-primary" type="submit" style="margin-left: 0px;"> Load </button> |

            </div>

        </form>
        @*<form asp-action="Index" method="get" class="row">
            <div class="col-3">
                <small>from</small>
                <input type="date" name="from" id="from" value="@from" class="form-control" />
            </div>
            <div class="col-3">
                <small>to</small>
                <input type="date" name="to" id="to" value="@to" class="form-control" />
            </div>
            <div class="col-3">
                <small>
                    user</
                    small>
                    @*<select name="UserId" id="UserId" class="form-control" asp-items="@{new SelectList(_ddlhelper.GetAllUsersList().Prepend(new KeyValuePair<string, string>("","-- Select User --")),"Key","Value",UserId)}"></select>*@

        @*</div>
                <div class="col-3">
                    <br />
                    <button type="submit" class="btn btn-success btn-sm">Load</button>
                </div>
            </form>*@

    </div>

    <hr />
    <div class="row table-responsive">

        @{
            var BillOfUser = _db.OrderHistory.Where(x => x.UserId == user.Id && x.OrderDate >= FromDate && x.OrderDate <= ToDate);
            var BillOfUserDefault = _db.OrderHistory.Where(x => x.UserId == user.Id);


        }


        @if (DateCheck)
        {
            <table class="table table-striped table-bordered">
                <thead class="grey lighten-2">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Issue Date</th>
                        <th scope="col">Order Date</th>
                        <th scope="col">Name</th>
                        <th scope="col">Type</th>
                        <th scope="col">Extra Item Details</th>
                        <th scope="col">Tk.</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int i = 1; }
                    @foreach (var oh in BillOfUser.OrderByDescending(x => x.OrderDate).Include(x => x.StoreOutItem).Include(y => y.MealType).ToList())
                    {
                    <tr>
                        <th scope="row">@(i++)</th>
                        <th>@oh.CreatedDate.ToShortDateString() <small>@oh.CreatedDate.ToShortTimeString()</small></th>
                        <th>@oh.OrderDate.ToShortDateString() </th>
                        <td>@oh.ApplicationUser.BUPFullName</td>
                        <td>@oh.MealType.Name</td>

                        @if (oh.StoreOutItemId != null)
                        {
                            <td>
                                @oh.StoreOutItem.Name
                            </td>
                        }
                        else
                        {
                            <td>
                                Set Menu
                            </td>
                        }
                            <td>@oh.OrderAmount</td>
                        </tr>
                    }
                    <tr>
                        <th scope="row"></th>
                        <th></th>
                        <th></th>
                        <td></td>
                        <td></td>
                        <td>
                            <strong>Total : </strong>
                        </td>
                        <td><strong>@BillOfUser.Sum(a => a.OrderAmount).ToString("#.##")</strong></td>
                    </tr>

                </tbody>
            </table>
        }

        else
        {
    <table class="table table-striped table-bordered">
        <thead class="grey lighten-2">
            <tr>
                <th scope="col">#</th>
                <th scope="col">Issue Date</th>
                <th scope="col">Order Date</th>
                <th scope="col">Name</th>
                <th scope="col">Type</th>
                <th scope="col">Extra Item Details</th>
                <th scope="col">Tk.</th>
            </tr>
        </thead>
        <tbody>
            @{ int i = 1; }
            @foreach (var oh in BillOfUserDefault.OrderByDescending(x => x.OrderDate).Include(x => x.StoreOutItem).Include(y => y.MealType).ToList())
            {
            <tr>
                <th scope="row">@(i++)</th>
                <th>@oh.CreatedDate.ToShortDateString() <small>@oh.CreatedDate.ToShortTimeString()</small></th>
                <th>@oh.OrderDate.ToShortDateString() </th>
                <td>@oh.ApplicationUser.BUPFullName</td>
                <td>@oh.MealType.Name</td>

                @if (oh.StoreOutItemId != null)
                {
                    <td>
                        @oh.StoreOutItem.Name
                    </td>

                }
                else
                {
                    <td>
                        SetMenu
                    </td>
                }
                <td>@oh.OrderAmount</td>
            </tr>
            }
            <tr>
                <th scope="row"></th>
                <th></th>
                <th></th>
                <td></td>
                <td></td>
                <td>
                    <strong>Total : </strong>
                </td>
                <td><strong>@BillOfUserDefault.Sum(a => a.OrderAmount).ToString("#.##")</strong></td>
            </tr>

        </tbody>
    </table>           
                }

        @*@if(!DateCheck)
        {
            <table class="table table-striped table-bordered">
                <thead class="grey lighten-2">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Issue Date</th>
                        <th scope="col">Order Date</th>
                        <th scope="col">Name</th>
                        <th scope="col">Type</th>
                        <th scope="col">Extra Item Details</th>
                        <th scope="col">Tk.</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int i = 1; }
                    @foreach (var oh in BillOfUserDefault.OrderByDescending(x => x.OrderDate).Include(x => x.StoreOutItem).Include(y => y.MealType).ToList())
                    {
                        <tr>
                            <th scope="row">@(i++)</th>
                            <th>@oh.CreatedDate.ToShortDateString() <small>@oh.CreatedDate.ToShortTimeString()</small></th>
                            <th>@oh.OrderDate.ToShortDateString() </th>
                            <td>@oh.ApplicationUser.BUPFullName</td>
                            <td>@oh.MealType.Name</td>
                            <td>
                                @if (oh.StoreOutItemId != null)
                                {
                                    @oh.StoreOutItem.Name
                                }
                            </td>
                            <td>@oh.OrderAmount</td>
                        </tr>
                    }
                    <tr>
                        <th scope="row"></th>
                        <th></th>
                        <th></th>
                        <td></td>
                        <td></td>
                        <td>
                            <strong>Total : </strong>
                        </td>
                        <td><strong>@BillOfUserDefault.Sum(a => a.OrderAmount).ToString("#.##")</strong></td>
                    </tr>

                </tbody>
            </table>
        }*@

    </div>

</div>




